# coding:utf-8

- name: スワップファイルの定義
  set_fact:
    swap_file_path: /var/swapfile

- name: スワップファイルの作成
  command: dd if=/dev/zero of={{ swap_file_path }} bs={{ ansible_memtotal_mb * 2 }} count=1M
  args:
    creates: '{{ swap_file_path }}'

- name: スワップファイルの権限設定
  file:
    path: '{{ swap_file_path }}'
    mode: '0600'

- name: スワップファイルが作成されてるか検査
  command: file {{ swap_file_path }}
  register: swap_file_test

- name: スワップファイル扱いじゃないなら、スワップファイルに変換
  command: mkswap {{ swap_file_path }}
  when: swap_file_test.stdout.find('swap file') == -1

- name: スワップon
  command: swapon {{ swap_file_path }}
  when: ansible_swaptotal_mb < 1

- name: スワップファイルをマウント
  mount:
    name: swap
    src: '{{ swap_file_path }}'
    fstype: swap
    opts: defaults
    passno: '0'
    dump: '0'
    state: present
