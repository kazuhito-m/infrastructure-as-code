202212付近でやってた、GROWI引っ越すための試行錯誤
===

2022/12/01〜2022/12/13 の期間くらいにやっていた「Herokuが停止するため自宅サーバにGrowiWikiを引っ越す作業」にて、調べた&参考にしたことを書き残す。


## Ansible

- 変数定義
  - https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_variables.html#defining-variables-in-a-play
- 「ファイルの存在」や「コマンドの終了ステータス」などを得て変数化する
  - https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_variables.html#defining-variables-in-included-files-and-roles
- templateモジュール
  - https://nwengblog.com/ansible-template/
- GalaxyのRole周りを仕込む方法
  - https://dev.classmethod.jp/articles/ansible-galaxy-intro/
  - レシピ内に含むことが出来ず、予め `ansible-galaxy install` を叩いておかなければならないみたいので、キックシェルにでも仕込むのがいいのだろうか？
- include_tasks
  - https://nwengblog.com/ansible-include-tasks/


## Elasticsearch

- Debianへのインストール
  - https://www.elastic.co/guide/en/elasticsearch/reference/6.8/deb.html
  - しかし、メモリが少なかったのか、AI周りの設定なのか、落ちては再起動という動きでグルグルしていた
- RapberryPIへのインストール
  - https://qiita.com/Y-Shikase/items/7e6025855454c443f620
  - ただし手持ちのRasPIは2で32bitなので動かず

## MongoDB

- Debianへのインストール
  - https://www.mongodb.com/docs/v4.4/tutorial/install-mongodb-on-debian/
  - コレ以前の問題で「32bitだから動かない」などが問題だった


### 実行時には必要だが、バックアップデータとしては必要のないファイル群

MongoDBが使うフォルダをそのままtgz等にアーカイブした場合、実データが数KB〜一桁MBくらいであるのにもかかわらず、数百MB〜数GBに膨らむディレクトリがある。

- `./journal`
- `./diagnostic.data`

最終的には「これら2つのディレクトリをバックアップから除く」で決着した。

が、 `./journal` については「設定で節約・上限制限出来る」ので、その情報を整理する。

- 設定ファイルに `smallfiles` を指定する例
  - https://stackoverflow.com/questions/19533019/is-it-safe-to-delete-the-journal-file-of-mongodb
  - https://qiita.com/syuhei/items/8d99f87d5ee57cd998ef
- `--smallfiles` オプションをdocker-composeで指定している例
  - https://qiita.com/gldn/items/2a8486c4d7a42d7a0f1f

### インストール

- ソースからのインストール
  - https://www.kkaneko.jp/tools/ubuntu/mongodbinstall.html
  - とある端末では「メモリが2GBでも失敗」し、とある端末では「32bit機なので出来ない」という風に、一つとして成功しなかった


## Nginx

- 仮想サーバで複数ドメインを1Nginxで扱う方法
  - https://snowtree-injune.com/2020/10/30/nginx-static-dj014/

## Let's Encrypt & CertBotによる「証明書更新」周り

- Nginxプラグインを使って、certbotで証明書手に入れてNginxのconfファイルも自動変更する
  - https://zenn.dev/hitoshiro/articles/b8170ec36d1f01
  - https://yoo-s.com/topic/detail/896 (Apache時)
- Ansible化するため、「非対話型」になるようcertbotのコマンドオプションを頑張る
  - https://qiita.com/s-katsumata/items/629222b24113d7a49b79
  - https://rolflekang.com/using-certbot-with-ansible
    - こちらの例はpipでcertbotをインストールする例だが
- aptでのcertbotインストール後、systemdで実際に定期実行するサービスは `certbot.timer`
  - https://unix.stackexchange.com/questions/413856/debian-and-certbot-where-does-the-package-install-the-cron-job
- Ubuntu 20.04でLet’s Encryptを使用してNginxを保護する方法
  - https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-20-04-ja
- Let's Encrypt+NginxでSSL証明書発行、自動更新の設定方法
  - https://qiita.com/yudsuzuk/items/83115236e9ca184326d2
  - こちらはCertBotを使わず「自力でnginxに仕込む」例
- SSL証明書チェッカー
  - https://www.ssllabs.com/ssltest/analyze.html

## NFSクライアント

- AnsibleでNFSクライアントを設定する方法
  - https://okisanjp.hatenablog.jp/entry/archives/5510


## NTPクライアント

今回調べているのは「NTPサーバ」ではなく「NTPサーバを使うNTPクライアント」周り。

すでに一台ほど「クライアントの設定したいが、間違えてサーバを仕込んでいた」ものが在った。

- `systemd/timesyncd.conf` に仕込むクライアントの設定
  - https://tarufu.info/raspberry-pi-ntp/

## Host名やローカルドメイン指定

- Ubuntuでホスト名とドメイン名を設定する方法
  - https://www.hiroom2.com/2018/05/30/ubuntu-1804-hostname-ja/
  - DHCPの `option host-name` 設定が気になる
    - IPさえ設定していればHost名やサーチ用ドメイン名がいらなくなる？


## GROWI関連

### Dockerでのインストール

- DockerでGROWIを動かすためのdocker-compseリポジトリ
  - https://github.com/weseek/growi-docker-compose

### 素でのインストール

- 公式のインストールガイド(ただしUbuntuServer)
  - https://docs.growi.org/ja/admin-guide/getting-started/ubuntu-server.html
- yarnでビルドした時に、httpでライブラリダウンロードしようとして、タイムアウトする場合の対策
  - https://qiita.com/GandT/items/9c2afa82609ff6062fd3
- ソースリポジトリ
  - https://github.com/weseek/growi

### RaspberryPiへのインストール

結局、以下の選択肢は「持ってるRaspberryPIが32bitARMだった」ので、何一つ使えない(動かない)だった。

- Raspberry Pi 4 Model B (Ubuntu) に GROWI 導入
  - https://qiita.com/steepay/items/96605cfbdd78995d707f
  - バラで入れる例
- ラズパイ上にDockerコンテナを使ってGrowiを簡単に構築する
  - https://qiita.com/reolch/items/15fc760de185716c029d
  - RasPIにDocker入れて、その上で構築する例
  - 公式のgrowi-docker-composeからForkした別リポジトリのカスタムymlで動かす

### バックアップ

- Growiのバックアップとリカバリの手順
  - https://qiita.com/SkyLaptor/items/d02b702764428a08e3f5

## ディストリビューションインストール周り

### 他マシーンでインストール->別マシーンのディスクにコピー

アーキテクチャ(x86_64,i386等)さえあっていれば、ddコマンド等で「イメージコピー」すれば動く、ということが解った。

- SSD/HDDをインストール時に「容量の少ないパーティション」に切っておき、あとで容量限界まで拡張する方法
  - https://www.faq.idcf.jp/app/answers/detail/a_id/121/

### Debianインストール

- Debianイメージ(32bit/64bit)のダウンロードサイト
  - https://www.debian.or.jp/cdimage/


## HP ThinClient HP t5735の改造

- 元のフラッシュメモリが刺さってたとこにSSDへとつなぎ替える改造
  - http://harunoyuki.blogspot.com/2011/03/t5730-ssd.html
  - https://remu-link.hatenablog.com/entry/20090816
- (関係ないけど)PCIポートを使ってSSDつなぐ方法
  - https://soltec.exblog.jp/11472519/

## MouseComputerのスティックPC m-Stick MS-NH1へのLinuxインストール

本来、Windousが入っているマウスのスティックPCは、Linuxサーバに最適なので、Debianブートにして利用したい。

が「UFEIなのに32bit機」というのが、一筋縄ではインストーラなどでBoot出来ないっぽい。

そこで「いろいろ駆使して入れ替える」という情報を集めた。(未実行)

- `MouseComputer m-Stick MS-NH1` スペック
  - https://labs.m2hq.net/Memo/PC/MS-NH1
- m-Stick MS-NH1にUbuntuをインストールする。
  - https://lactoria.web.fc2.com/mstick1-euc.html
  - ここのサイトに `32bit UEFI` はおかしい、という説明がある
- 激安スティックPCにLinux Ubuntuをインストールする
  - http://akiba.jpn.org/?p=37930
- 32bit UEFIなスティックPC(MS-NH1)に最新のUbuntu(20.04)を入れて動かした
  - https://qiita.com/konton/items/beff2897e1fe33e20b2a
- USB HDDにMBR/EFI両ブート可能なUbuntuイメージを作る方法
  - https://bellbind.tumblr.com/post/45757405213

## Docker/docker-compose周り

- 公式の「Docker/docker-composeをDebianへインストール」方法
  - https://docs.docker.com/engine/install/debian/
- (余談)DebianのDockerパッケージの「名前がおかしい」という問題定期
  - https://lists.debian.org/debian-devel/2022/12/msg00034.html
  - この話をしたTwitterの人が、本家Debianに「今の状態はよくない」と問題定期してくれはった
